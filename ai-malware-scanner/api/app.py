from fastapi import FastAPI, UploadFile, File
from pydantic import BaseModel
from models.cloud_model import ModelWrapper

app = FastAPI()
model = ModelWrapper.get_instance()

class Features(BaseModel):
    features: list

@app.post("/predict")
def predict(features: Features):
    """
    Predict if a sample is malicious based on its features.
    """
    result = model.predict(features.features)
    return result

@app.post("/upload")
async def upload_file(file: UploadFile = File(...)):
    """
    Endpoint to upload a file for scanning and predict directly from the file.
    """
    try:
        # Save the uploaded file temporarily
        file_path = f"temp/{file.filename}"
        with open(file_path, "wb") as f:
            f.write(await file.read())
        
        # Extract features from the file
        features = extract_features_from_file(file_path)
        
        # Perform prediction
        result = model.predict(features)
        
        return {"filename": file.filename, "prediction": result}
    except Exception as e:
        return {"error": str(e)}

def extract_features_from_file(file_path: str):
    """
    Placeholder function to extract features from a file.
    Replace this with actual feature extraction logic.
    """
    # Example: Return dummy features for now
    return [0.1, 0.5, 0.3, 0.9]
